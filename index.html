<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>供应链ERP系统 - 首页看板</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  
  <!-- 配置Tailwind自定义主题 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            success: '#52C41A',
            warning: '#FAAD14',
            danger: '#FF4D4F',
            info: '#722ED1',
            gray: {
              100: '#F5F7FA',
              200: '#E5E6EB',
              300: '#C9CDD4',
              400: '#86909C',
              500: '#4E5969',
              600: '#272E3B',
              700: '#1D2129',
            }
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card {
        @apply bg-white rounded-xl shadow-sm border border-gray-200 p-5 transition-all duration-300 hover:shadow-md;
      }
      .stat-card {
        @apply card flex flex-col gap-2;
      }
      .badge {
        @apply text-xs px-2 py-0.5 rounded-full font-medium;
      }
      .period-btn {
        @apply px-3 py-1 text-sm rounded-md transition-colors;
      }
      .period-btn.active {
        @apply bg-primary text-white;
      }
      .period-btn.inactive {
        @apply text-gray-500 hover:bg-gray-100;
      }
    }
  </style>
  
  <style>
    /* 确保页面可以滚动 */
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    /* 自定义滚动条样式 */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
    
    /* 自定义搜索框样式 */
    .search-container {
      position: relative;
      width: 240px;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #E5E6EB;
      border-radius: 6px;
      background-color: white;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #165DFF;
      box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.1);
    }
    
    .search-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #E5E6EB;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .search-dropdown.active {
      display: block;
    }
    
    .search-item {
      padding: 8px 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .search-item:hover {
      background-color: #F5F7FA;
    }
    
    .search-item.selected {
      background-color: #E8F3FF;
      color: #165DFF;
    }
    
    .search-empty {
      padding: 12px;
      text-align: center;
      color: #86909C;
      font-size: 14px;
    }
  </style>
</head>
<body class="font-inter bg-gray-100 text-gray-700 min-h-screen">
  <!-- 主内容区 -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- 页面内容 - 确保可滚动 -->
    <main class="flex-1 overflow-y-auto p-6 bg-gray-100" style="height: calc(100vh);">
      
      <!-- 周期选择器 - 全局周期控制 -->
      <div class="mb-6 flex justify-end gap-2">
        <span class="text-sm text-gray-500 flex items-center">数据周期:</span>
        <button class="period-btn active" data-period="week" id="global-period-week">周度</button>
        <button class="period-btn inactive" data-period="month" id="global-period-month">月度</button>
      </div>
      
      <!-- 数据概览卡片 -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <!-- 采购申请 -->
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">采购申请</p>
              <h3 class="text-3xl font-bold mt-1 data-value" data-week="32" data-month="128">32</h3>
            </div>
            <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary">
              <i class="fa fa-file-text-o text-xl"></i>
            </div>
          </div>
          <div class="flex items-center gap-1 mt-2">
            <span class="text-success flex items-center text-sm data-change" data-week="+8.2%" data-month="+12.5%">
              <i class="fa fa-arrow-up mr-1"></i>8.2%
            </span>
            <span class="text-gray-400 text-sm">较上期</span>
          </div>
          <div class="flex items-center justify-between mt-2">
            <div>
              <span class="text-xs text-gray-500">待处理:</span>
              <span class="text-danger font-medium ml-1">8</span>
            </div>
            <button class="text-xs px-2 py-1 bg-primary text-white rounded hover:bg-primary/90 transition-colors">
              处理
            </button>
          </div>
          <div class="h-10 mt-2">
            <canvas class="sparkline" data-type="purchase-request"></canvas>
          </div>
        </div>
        
        <!-- 采购订单 -->
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">采购订单</p>
              <h3 class="text-3xl font-bold mt-1 data-value" data-week="24" data-month="96">24</h3>
            </div>
            <div class="w-12 h-12 rounded-full bg-secondary/10 flex items-center justify-center text-secondary">
              <i class="fa fa-shopping-cart text-xl"></i>
            </div>
          </div>
          <div class="flex items-center gap-1 mt-2">
            <span class="text-success flex items-center text-sm data-change" data-week="+5.7%" data-month="+8.3%">
              <i class="fa fa-arrow-up mr-1"></i>5.7%
            </span>
            <span class="text-gray-400 text-sm">较上期</span>
          </div>
          <div class="flex items-center justify-between mt-2">
            <div>
              <span class="text-xs text-gray-500">待处理:</span>
              <span class="text-danger font-medium ml-1">5</span>
            </div>
            <button class="text-xs px-2 py-1 bg-primary text-white rounded hover:bg-primary/90 transition-colors">
              处理
            </button>
          </div>
          <div class="h-10 mt-2">
            <canvas class="sparkline" data-type="purchase-order"></canvas>
          </div>
        </div>
        
        <!-- 入库单 -->
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">入库单</p>
              <h3 class="text-3xl font-bold mt-1 data-value" data-week="18" data-month="72">18</h3>
            </div>
            <div class="w-12 h-12 rounded-full bg-success/10 flex items-center justify-center text-success">
              <i class="fa fa-sign-in text-xl"></i>
            </div>
          </div>
          <div class="flex items-center gap-1 mt-2">
            <span class="text-danger flex items-center text-sm data-change" data-week="-1.2%" data-month="-3.1%">
              <i class="fa fa-arrow-down mr-1"></i>1.2%
            </span>
            <span class="text-gray-400 text-sm">较上期</span>
          </div>
          <div class="flex items-center justify-between mt-2">
            <div>
              <span class="text-xs text-gray-500">待处理:</span>
              <span class="text-danger font-medium ml-1">3</span>
            </div>
            <button class="text-xs px-2 py-1 bg-primary text-white rounded hover:bg-primary/90 transition-colors">
              处理
            </button>
          </div>
          <div class="h-10 mt-2">
            <canvas class="sparkline" data-type="receipt-note"></canvas>
          </div>
        </div>
        
        <!-- 发货单 -->
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">发货单</p>
              <h3 class="text-3xl font-bold mt-1 data-value" data-week="16" data-month="64">16</h3>
            </div>
            <div class="w-12 h-12 rounded-full bg-warning/10 flex items-center justify-center text-warning">
              <i class="fa fa-truck text-xl"></i>
            </div>
          </div>
          <div class="flex items-center gap-1 mt-2">
            <span class="text-success flex items-center text-sm data-change" data-week="+12.3%" data-month="+15.2%">
              <i class="fa fa-arrow-up mr-1"></i>12.3%
            </span>
            <span class="text-gray-400 text-sm">较上期</span>
          </div>
          <div class="flex items-center justify-between mt-2">
            <div>
              <span class="text-xs text-gray-500">待处理:</span>
              <span class="text-danger font-medium ml-1">6</span>
            </div>
            <button class="text-xs px-2 py-1 bg-primary text-white rounded hover:bg-primary/90 transition-colors">
              处理
            </button>
          </div>
          <div class="h-10 mt-2">
            <canvas class="sparkline" data-type="delivery-order"></canvas>
          </div>
        </div>
      </div>
      
      <!-- 主要图表区域 -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- 采购数量环比分析（柱状图+折线图） -->
        <div class="card">
          <div class="flex items-center justify-between mb-6">
            <h3 class="font-bold text-lg">采购数量环比分析</h3>
            <div class="flex items-center gap-3">
              <!-- 产品搜索框 -->
              <div class="search-container">
                <input type="text" class="search-input" id="product-search" placeholder="搜索产品..." autocomplete="off">
                <div class="search-dropdown" id="product-dropdown">
                  <!-- 产品列表将通过JavaScript动态生成 -->
                </div>
              </div>
              <div class="flex gap-2 chart-period" data-chart="purchaseComparisonChart">
                <button class="period-btn active" data-period="week">周度</button>
                <button class="period-btn inactive" data-period="month">月度</button>
              </div>
            </div>
          </div>
          <div class="h-80">
            <canvas id="purchaseComparisonChart"></canvas>
          </div>
        </div>
        
        <!-- 订单状态占比 -->
        <div class="card">
          <div class="flex items-center justify-between mb-6">
            <h3 class="font-bold text-lg">订单状态占比分析</h3>
            <div class="flex gap-2 chart-period" data-chart="orderStatusChart">
              <button class="period-btn active" data-period="week">周度</button>
              <button class="period-btn inactive" data-period="month">月度</button>
            </div>
          </div>
          <div class="h-80 flex">
            <div class="w-2/3">
              <canvas id="orderStatusChart"></canvas>
            </div>
            <div class="w-1/3 pl-4 flex flex-col justify-center">
              <div id="orderStatusLegend" class="space-y-3">
                <!-- 图例将通过JavaScript动态生成 -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
    </main>
  </div>

  <script>
    // 全局变量存储图表实例
    let charts = {};
    let currentGlobalPeriod = 'week'; // 当前全局周期
    let currentProduct = 'all'; // 当前选中的产品
    
    // 产品数据 - 模拟不同产品的采购数据
    const productData = {
      all: {
        name: '全部产品',
        week: {
          labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
          current: [85, 92, 105, 98, 112, 78, 65],
          previous: [72, 85, 92, 88, 105, 70, 60],
          growthRate: [18.1, 8.2, 14.1, 11.4, 6.7, 11.4, 8.3] // 环比增长率(%)
        },
        month: {
          labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
          current: [650, 780, 820, 950, 1080, 1250],
          previous: [580, 720, 760, 890, 980, 1120],
          growthRate: [12.1, 8.3, 7.9, 6.7, 10.2, 11.6] // 环比增长率(%)
        }
      },
      product1: {
        name: '神奇螺栓',
        week: {
          labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
          current: [35, 42, 55, 48, 62, 38, 25],
          previous: [32, 35, 42, 38, 55, 30, 20],
          growthRate: [9.4, 20.0, 31.0, 26.3, 12.7, 26.7, 25.0]
        },
        month: {
          labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
          current: [250, 280, 320, 350, 380, 420],
          previous: [230, 260, 290, 320, 350, 380],
          growthRate: [8.7, 7.7, 10.3, 9.4, 8.6, 10.5]
        }
      },
      product2: {
        name: '美味草莓',
        week: {
          labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
          current: [20, 22, 25, 23, 27, 18, 15],
          previous: [18, 20, 22, 21, 25, 17, 14],
          growthRate: [11.1, 10.0, 13.6, 9.5, 8.0, 5.9, 7.1]
        },
        month: {
          labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
          current: [150, 170, 180, 200, 220, 240],
          previous: [140, 160, 170, 190, 210, 230],
          growthRate: [7.1, 6.3, 5.9, 5.3, 4.8, 4.3]
        }
      },
      product3: {
        name: '大西瓜',
        week: {
          labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
          current: [15, 17, 18, 16, 19, 12, 10],
          previous: [13, 15, 16, 15, 18, 11, 9],
          growthRate: [15.4, 13.3, 12.5, 6.7, 5.6, 9.1, 11.1]
        },
        month: {
          labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
          current: [120, 130, 140, 150, 160, 170],
          previous: [110, 120, 130, 140, 150, 160],
          growthRate: [9.1, 8.3, 7.7, 7.1, 6.7, 6.3]
        }
      },
      product4: {
        name: '小西瓜',
        week: {
          labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
          current: [10, 8, 12, 9, 11, 7, 5],
          previous: [9, 7, 10, 8, 10, 6, 4],
          growthRate: [11.1, 14.3, 20.0, 12.5, 10.0, 16.7, 25.0]
        },
        month: {
          labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
          current: [80, 90, 100, 110, 120, 130],
          previous: [70, 80, 90, 100, 110, 120],
          growthRate: [14.3, 12.5, 11.1, 10.0, 9.1, 8.3]
        }
      },
      product5: {
        name: '超级香氛机1号',
        week: {
          labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
          current: [5, 3, 5, 2, 3, 3, 10],
          previous: [4, 2, 4, 2, 2, 2, 8],
          growthRate: [25.0, 50.0, 25.0, 0.0, 50.0, 50.0, 25.0]
        },
        month: {
          labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
          current: [50, 60, 80, 90, 100, 110],
          previous: [40, 50, 70, 80, 90, 100],
          growthRate: [25.0, 20.0, 14.3, 12.5, 11.1, 10.0]
        }
      },
      product6: {
        name: '超级香氛机2号',
        week: {
          labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
          current: [8, 10, 12, 9, 11, 6, 7],
          previous: [7, 9, 10, 8, 10, 5, 6],
          growthRate: [14.3, 11.1, 20.0, 12.5, 10.0, 20.0, 16.7]
        },
        month: {
          labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
          current: [70, 80, 90, 100, 110, 120],
          previous: [65, 75, 85, 95, 105, 115],
          growthRate: [7.7, 6.7, 5.9, 5.3, 4.8, 4.3]
        }
      },
      product7: {
        name: '神秘大荔枝',
        week: {
          labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
          current: [12, 14, 16, 13, 15, 10, 8],
          previous: [11, 13, 15, 12, 14, 9, 7],
          growthRate: [9.1, 7.7, 6.7, 8.3, 7.1, 11.1, 14.3]
        },
        month: {
          labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
          current: [90, 100, 110, 120, 130, 140],
          previous: [85, 95, 105, 115, 125, 135],
          growthRate: [5.9, 5.3, 4.8, 4.3, 4.0, 3.7]
        }
      }
    };
    
    // 全局周期切换功能 - 控制所有周期选择器
    function setupGlobalPeriodToggle() {
      const globalWeekBtn = document.getElementById('global-period-week');
      const globalMonthBtn = document.getElementById('global-period-month');
      
      globalWeekBtn.addEventListener('click', function() {
        updateGlobalPeriod('week');
      });
      
      globalMonthBtn.addEventListener('click', function() {
        updateGlobalPeriod('month');
      });
    }
    
    // 更新全局周期
    function updateGlobalPeriod(period) {
      currentGlobalPeriod = period;
      
      // 更新全局周期按钮状态
      updateGlobalPeriodButtons(period);
      
      // 更新所有图表周期按钮状态
      updateAllChartPeriodButtons(period);
      
      // 更新数据卡片
      updateDataCards(period);
      
      // 更新迷你图表
      updateSparklineCharts(period);
      
      // 更新所有图表数据
      updateAllCharts(period);
    }
    
    // 更新全局周期按钮状态
    function updateGlobalPeriodButtons(period) {
      const globalWeekBtn = document.getElementById('global-period-week');
      const globalMonthBtn = document.getElementById('global-period-month');
      
      globalWeekBtn.classList.remove('active', 'inactive');
      globalWeekBtn.classList.add(period === 'week' ? 'active' : 'inactive');
      
      globalMonthBtn.classList.remove('active', 'inactive');
      globalMonthBtn.classList.add(period === 'month' ? 'active' : 'inactive');
    }
    
    // 更新所有图表周期按钮状态
    function updateAllChartPeriodButtons(period) {
      document.querySelectorAll('.chart-period').forEach(chartPeriod => {
        const buttons = chartPeriod.querySelectorAll('.period-btn');
        
        buttons.forEach(btn => {
          btn.classList.remove('active', 'inactive');
          btn.classList.add(btn.dataset.period === period ? 'active' : 'inactive');
        });
      });
    }
    
    // 更新数据卡片
    function updateDataCards(period) {
      // 更新数据卡片数值
      document.querySelectorAll('.data-value').forEach(el => {
        el.textContent = el.dataset[period];
      });
      
      // 更新数据卡片变化率
      document.querySelectorAll('.data-change').forEach(el => {
        const value = el.dataset[period];
        const isPositive = value.startsWith('+');
        el.innerHTML = `<i class="fa fa-arrow-${isPositive ? 'up' : 'down'} mr-1"></i>${value.replace(/[+-]/, '')}`;
        el.className = isPositive ? 'text-success flex items-center text-sm data-change' : 'text-danger flex items-center text-sm data-change';
      });
    }
    
    // 更新迷你图表
    function updateSparklineCharts(period) {
      if (['week', 'month'].includes(period)) {
        document.querySelectorAll('.sparkline').forEach(canvas => {
          const chartData = JSON.parse(canvas.dataset.chartData);
          if (chartData[period]) {
            canvas.chartInstance.data.datasets[0].data = chartData[period];
            canvas.chartInstance.update();
          }
        });
      }
    }
    
    // 更新所有图表数据
    function updateAllCharts(period) {
      Object.keys(charts).forEach(chartId => {
        updateChartPeriod(chartId, period);
      });
    }
    
    // 单个图表周期切换功能 - 只控制自己的数据，不影响全局
    function setupChartPeriodToggle() {
      document.querySelectorAll('.chart-period').forEach(chartPeriod => {
        const buttons = chartPeriod.querySelectorAll('.period-btn');
        const chartId = chartPeriod.dataset.chart;
        
        buttons.forEach(btn => {
          btn.addEventListener('click', function() {
            const period = this.dataset.period;
            
            // 只更新当前图表的周期按钮状态
            buttons.forEach(b => {
              b.classList.remove('active', 'inactive');
              b.classList.add(b.dataset.period === period ? 'active' : 'inactive');
            });
            
            // 只更新当前图表的数据
            updateChartPeriod(chartId, period);
          });
        });
      });
    }
    
    // 设置产品搜索功能
    function setupProductSearch() {
      const searchInput = document.getElementById('product-search');
      const dropdown = document.getElementById('product-dropdown');
      
      // 初始显示全部产品
      searchInput.value = productData.all.name;
      
      // 点击输入框时显示下拉列表
      searchInput.addEventListener('focus', function() {
        updateProductDropdown('');
        dropdown.classList.add('active');
      });
      
      // 输入时过滤产品
      searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        updateProductDropdown(query);
        dropdown.classList.add('active');
      });
      
      // 点击外部时隐藏下拉列表
      document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.remove('active');
        }
      });
      
      // 选择产品
      dropdown.addEventListener('click', function(e) {
        if (e.target.classList.contains('search-item')) {
          const productId = e.target.dataset.id;
          selectProduct(productId);
          dropdown.classList.remove('active');
        }
      });
    }
    
    // 更新产品下拉列表
    function updateProductDropdown(query) {
      const dropdown = document.getElementById('product-dropdown');
      let html = '';
      
      // 过滤产品
      const filteredProducts = Object.entries(productData).filter(([id, product]) => {
        return product.name.toLowerCase().includes(query.toLowerCase());
      });
      
      if (filteredProducts.length === 0) {
        html = '<div class="search-empty">未找到匹配的产品</div>';
      } else {
        filteredProducts.forEach(([id, product]) => {
          const isSelected = id === currentProduct;
          html += `<div class="search-item ${isSelected ? 'selected' : ''}" data-id="${id}">${product.name}</div>`;
        });
      }
      
      dropdown.innerHTML = html;
    }
    
    // 选择产品
    function selectProduct(productId) {
      currentProduct = productId;
      const product = productData[productId];
      
      // 更新搜索框显示
      document.getElementById('product-search').value = product.name;
      
      // 更新图表数据
      updateChartPeriod('purchaseComparisonChart', currentGlobalPeriod);
    }
    
    // 初始化迷你图表
    function initSparklineCharts() {
      document.querySelectorAll('.sparkline').forEach(canvas => {
        const ctx = canvas.getContext('2d');
        const type = canvas.dataset.type;
        
        // 不同类型图表的周期数据
        const data = {
          'purchase-request': {
            week: [5, 4, 6, 5, 7, 3, 2],
            month: [13, 5, 26, 24, 14, 25, 33, 5, 24, 28, 24, 8],
          },
          'purchase-order': {
            week: [4, 3, 5, 4, 6, 2, 2],
            month: [10, 2, 12, 14, 25, 16, 45, 10, 20, 8, 4, 23],
          },
          'receipt-note': {
            week: [3, 2, 4, 3, 5, 1, 2],
            month: [8, 2, 6, 20, 15, 14, 25, 18, 17, 14, 19, 4],
          },
          'delivery-order': {
            week: [2, 3, 4, 3, 5, 1, 2],
            month: [6, 5, 9, 11, 20, 13, 6, 17, 4, 19, 10, 18],
          }
        };
        
        // 根据类型设置颜色
        const colors = {
          'purchase-request': '#165DFF',
          'purchase-order': '#36CFC9',
          'receipt-note': '#52C41A',
          'delivery-order': '#FAAD14'
        };
        
        // 创建图表实例
        const chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: Array(data[type].week.length).fill(''),
            datasets: [{
              data: data[type].week,
              borderColor: colors[type],
              backgroundColor: `${colors[type]}33`, // 添加透明度
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: false },
              y: { display: false }
            },
            elements: { line: { tension: 0.4 } },
            animation: { duration: 1000 }
          }
        });
        
        // 存储图表数据和实例
        canvas.dataset.chartData = JSON.stringify(data[type]);
        canvas.dataset.chartColor = colors[type];
        canvas.chartInstance = chart;
      });
    }
    
    // 初始化采购数量环比分析图表（柱状图+折线图）
    function initPurchaseComparisonChart() {
      const ctx = document.getElementById('purchaseComparisonChart').getContext('2d');
      
      // 创建图表 - 使用组合图表，确保折线图在最前面
      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: productData.all.week.labels,
          datasets: [
            // 环比增长率放在第一个数据集，确保在最前面
            {
              label: '环比增长率(%)',
              data: productData.all.week.growthRate,
              type: 'line',
              borderColor: '#FAAD14',
              backgroundColor: 'transparent',
              borderWidth: 3,
              pointBackgroundColor: '#FFFFFF',
              pointBorderColor: '#FAAD14',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 7,
              tension: 0.3,
              yAxisID: 'y1',
              order: 0 // 设置为0确保在最前面
            },
            {
              label: '本周期数量',
              data: productData.all.week.current,
              backgroundColor: '#165DFF',
              borderRadius: 4,
              yAxisID: 'y',
              order: 1
            },
            {
              label: '上周期数量',
              data: productData.all.week.previous,
              backgroundColor: '#E8F3FF',
              borderRadius: 4,
              yAxisID: 'y',
              order: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                boxWidth: 6
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.datasetIndex === 0) {
                    // 增长率数据格式化
                    label += context.raw + '%';
                  } else {
                    // 数量数据格式化
                    label += context.raw >= 1000 ? (context.raw / 1000) + 'k' : context.raw;
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { font: { size: 11 } }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: '采购数量',
                font: { size: 11 }
              },
              beginAtZero: true,
              grid: { color: '#F0F2F5' },
              ticks: { 
                font: { size: 11 },
                callback: function(value) {
                  return value >= 1000 ? (value / 1000) + 'k' : value;
                }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: '环比增长率(%)',
                font: { size: 11 },
                color: '#FAAD14'
              },
              grid: {
                drawOnChartArea: false // 不在图表区域绘制网格线
              },
              ticks: { 
                font: { size: 11 },
                color: '#FAAD14',
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          },
          animation: {
            duration: 1500,
            easing: 'easeOutQuart'
          },
          barPercentage: 0.6,
          categoryPercentage: 0.7
        }
      });
      
      // 存储图表实例
      charts.purchaseComparisonChart = {
        instance: chart
      };
    }
    
    // 初始化订单状态占比图表
    function initOrderStatusChart() {
      const ctx = document.getElementById('orderStatusChart').getContext('2d');
      
      // 订单状态颜色映射
      const statusColors = {
        '新建': '#708096',
        '审批中': '#004BF9',
        '审批通过': '#52C41A',
        '审批拒绝': '#FF4D4F',
        '变更中': '#F3A200',
        '变更拒绝': '#6005E1'
      };
      
      // 周期数据
      const data = {
        week: {
          labels: ['新建', '审批中', '审批通过', '审批拒绝', '变更中', '变更拒绝'],
          values: [8, 12, 35, 5, 3, 2]
        },
        month: {
          labels: ['新建', '审批中', '审批通过', '审批拒绝', '变更中', '变更拒绝'],
          values: [10, 50, 170, 5, 4, 20]
        }
      };
      
      // 创建图表
      const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.week.labels,
          datasets: [{
            data: data.week.values,
            backgroundColor: Object.values(statusColors),
            borderWidth: 0,
            hoverOffset: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false // 隐藏默认图例
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          },
          cutout: '65%',
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1500,
            easing: 'easeOutQuart'
          }
        }
      });
      
      // 存储图表数据和实例
      charts.orderStatusChart = {
        instance: chart,
        data: data,
        colors: statusColors
      };
      
      // 初始化自定义图例
      updateOrderStatusLegend('week');
      
      // 添加环形图标签
      addDoughnutLabels(chart, data.week, statusColors);
    }
    
    // 添加环形图标签
    function addDoughnutLabels(chart, data, colors) {
      const ctx = chart.ctx;
      const total = data.values.reduce((a, b) => a + b, 0);
      
      // 插件：在环形图上绘制标签
      const doughnutLabelPlugin = {
        id: 'doughnutLabel',
        afterDraw(chart) {
          const { ctx } = chart;
          const meta = chart.getDatasetMeta(0);
          
          if (!meta.data || meta.data.length === 0) return;
          
          // 设置文本样式
          ctx.save();
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.font = 'bold 12px Inter, system-ui, sans-serif';
          
          meta.data.forEach((arc, index) => {
            // 计算标签位置 - 在扇区的中间位置
            const angle = arc.startAngle + (arc.endAngle - arc.startAngle) / 2;
            const radius = (arc.innerRadius + arc.outerRadius) / 2;
            
            const x = arc.x + Math.cos(angle) * radius;
            const y = arc.y + Math.sin(angle) * radius;
            
            // 根据背景色决定文字颜色（深色背景用白色，浅色背景用黑色）
            const backgroundColor = Object.values(colors)[index];
            const isLightColor = isColorLight(backgroundColor);
            ctx.fillStyle = isLightColor ? '#1D2129' : '#FFFFFF';
            
            // 获取标签文本
            const label = data.labels[index];
            const value = data.values[index];
            const percentage = Math.round((value / total) * 100);
            
            // 绘制标签
            ctx.fillText(label, x, y - 8);
            ctx.font = '10px Inter, system-ui, sans-serif';
            ctx.fillText(`${percentage}%`, x, y + 8);
          });
          
          ctx.restore();
        }
      };
      
      // 注册插件
      if (!Chart.registry.getPlugin('doughnutLabel')) {
        Chart.register(doughnutLabelPlugin);
      }
    }
    
    // 判断颜色是否为浅色
    function isColorLight(color) {
      // 将颜色转换为RGB
      let r, g, b;
      
      if (color.startsWith('#')) {
        // 处理十六进制颜色
        const hex = color.replace('#', '');
        r = parseInt(hex.substr(0, 2), 16);
        g = parseInt(hex.substr(2, 2), 16);
        b = parseInt(hex.substr(4, 2), 16);
      } else {
        // 处理rgb颜色
        const rgb = color.match(/\d+/g);
        r = parseInt(rgb[0]);
        g = parseInt(rgb[1]);
        b = parseInt(rgb[2]);
      }
      
      // 计算亮度（使用相对亮度公式）
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.6;
    }
    
    // 更新订单状态图例
    function updateOrderStatusLegend(period) {
      const chartInfo = charts.orderStatusChart;
      if (!chartInfo) return;
      
      const data = chartInfo.data[period];
      const colors = chartInfo.colors;
      const total = data.values.reduce((a, b) => a + b, 0);
      
      const legendContainer = document.getElementById('orderStatusLegend');
      let legendHTML = '';
      
      data.labels.forEach((label, index) => {
        const value = data.values[index];
        const percentage = Math.round((value / total) * 100);
        const color = Object.values(colors)[index];
        
        legendHTML += `
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></div>
              <span class="text-sm text-gray-600">${label}</span>
            </div>
            <div class="text-right">
              <div class="text-sm font-medium text-gray-800">${value}</div>
              <div class="text-xs text-gray-500">${percentage}%</div>
            </div>
          </div>
        `;
      });
      
      // 添加总计
      legendHTML += `
        <div class="pt-3 mt-3 border-t border-gray-200">
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium text-gray-700">总计</span>
            <div class="text-right">
              <div class="text-sm font-bold text-gray-800">${total}</div>
              <div class="text-xs text-gray-500">100%</div>
            </div>
          </div>
        </div>
      `;
      
      legendContainer.innerHTML = legendHTML;
    }
    
    // 更新图表周期数据
    function updateChartPeriod(chartId, period) {
      const chartInfo = charts[chartId];
      if (!chartInfo) return;
      
      const chart = chartInfo.instance;
      
      if (chartId === 'purchaseComparisonChart') {
        // 获取当前产品和周期的数据
        const data = productData[currentProduct][period];
        
        // 更新采购对比图表（柱状图+折线图）
        chart.data.labels = data.labels;
        chart.data.datasets[0].data = data.growthRate; // 环比增长率
        chart.data.datasets[1].data = data.current; // 本周期数量
        chart.data.datasets[2].data = data.previous; // 上周期数量
      } else if (chartId === 'orderStatusChart') {
        // 更新订单状态图表
        const data = chartInfo.data[period];
        chart.data.labels = data.labels;
        chart.data.datasets[0].data = data.values;
        // 更新自定义图例
        updateOrderStatusLegend(period);
      } 
      
      chart.update();
    }
    
    // 初始化所有图表和交互
    document.addEventListener('DOMContentLoaded', function() {
      setupGlobalPeriodToggle();
      setupChartPeriodToggle();
      setupProductSearch();
      initSparklineCharts();
      initPurchaseComparisonChart();
      initOrderStatusChart();
    });
  </script>
</body>
</html>